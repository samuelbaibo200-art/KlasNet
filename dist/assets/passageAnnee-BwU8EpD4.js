import{d as e}from"./index-D9-ZheVl.js";let p;try{p=require("./defaultFraisScolaires").ensureDefaultFrais}catch{p=void 0}function F(h){const{useDFA:g=!1,dfa:m={},seuilAdmission:I=10,nouvelleAnnee:n,fallbackToReset:A=!0,preserveEleves:w=!0,resetFinances:E=!0}=h,S=e.getAll("eleves"),i=e.getAll("classes"),f=e.getAll("notes"),R=e.getAll("paiements"),U={date:new Date().toISOString(),eleves:S,classes:i,notes:f,paiements:R,compositions:e.getAll("compositions"),fraisScolaires:e.getAll("fraisScolaires"),type:"archive_pre_passage_annee"};try{const a=new Blob([JSON.stringify(U,null,2)],{type:"application/json"}),s=window.URL.createObjectURL(a),t=document.createElement("a");t.href=s,t.download=`archive_pre_passage_${new Date().getFullYear()}.json`,t.click(),window.URL.revokeObjectURL(s)}catch{}e.addHistorique({type:"autre",cible:"Système",description:`Passage d'année déclenché (${g?"DFA":"Reset simple"}) vers ${n}`,utilisateur:"ADMIN"});let v=0,y=0;if(g){if(f.length===0&&!A)throw new Error("Aucune note disponible pour calculer la DFA");if(f.length===0&&A)return D();const a=Object.keys(m).length?m:(function(){const u={},c=e.getAll("notes"),o={};return c.forEach(l=>{o[l.eleveId]=o[l.eleveId]||[],o[l.eleveId].push(Number(l.valeur||0))}),Object.keys(o).forEach(l=>{const r=o[l];u[l]=Math.round(r.reduce((d,k)=>d+k,0)/r.length*100)/100}),u})(),s=["Petite Section","Moyenne Section","Grande Section","CP1","CP2","CE1","CE2","CM1","CM2"];S.forEach(t=>{const u=a[t.id]??0,c=i.find(l=>l.id===t.classeId);if(!c)return;const o=s.indexOf(c.niveau);if(u>=I)if(o>=0&&o<s.length-1){const l=s[o+1],r=i.find(d=>d.niveau===l&&d.section===c.section&&d.anneeScolaire===n);r&&(e.update("eleves",t.id,{classeId:r.id,anneeEntree:n}),v++)}else e.update("eleves",t.id,{statut:"Inactif"}),v++;else e.update("eleves",t.id,{anneeEntree:n}),y++})}else return D();i.forEach(a=>{e.update("classes",a.id,{anneeScolaire:n})});const b=e.getAll("ecole")[0];return b&&e.update("ecole",b.id,{anneeScolaireActive:n}),E&&e.getAll("paiements").forEach(a=>e.delete("paiements",a.id)),{promoted:v,heldBack:y};function D(){w?e.getAll("eleves").forEach(t=>{e.update("eleves",t.id,{classeId:"",anneeEntree:n})}):e.getAll("eleves").forEach(t=>{e.update("eleves",t.id,{statut:"Inactif"})});try{p&&p(n)}catch{}E&&e.getAll("paiements").forEach(s=>e.delete("paiements",s.id)),i.forEach(s=>{e.update("classes",s.id,{anneeScolaire:n})});const a=e.getAll("ecole")[0];return a&&e.update("ecole",a.id,{anneeScolaireActive:n}),e.addHistorique({type:"autre",cible:"Système",description:`Reset simple appliqué pour année ${n}`,utilisateur:"ADMIN"}),{promoted:0,heldBack:0}}}export{F as passageAnneeScolaire};
